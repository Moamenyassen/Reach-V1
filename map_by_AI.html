<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct Distribution Command Center - Map By AI</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f8f9fa;
            overflow: hidden; /* Prevent body scroll */
        }

        /* Navbar Styling */
        .navbar {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .navbar-brand {
            font-weight: 700;
            color: white !important;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Controls Section */
        .controls-bar {
            background: white;
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            z-index: 900;
            position: relative;
        }

        /* Map Container */
        #map {
            height: calc(100vh - 140px); /* Adjust based on navbar + controls height */
            width: 100%;
            z-index: 1;
        }

        /* Floating Stats Card */
        .stats-card {
            position: absolute;
            bottom: 30px;
            left: 30px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            border-left: 5px solid #2a5298;
            min-width: 200px;
        }
        .stats-number {
            font-size: 1.8rem;
            font-weight: 800;
            color: #2a5298;
            line-height: 1;
        }
        .stats-label {
            font-size: 0.85rem;
            color: #6c757d;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Custom Marker Styles */
        .custom-marker {
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 3px 5px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }
        .custom-marker:hover {
            transform: scale(1.2);
            z-index: 1000 !important;
        }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loading-overlay">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
        <h4 class="fw-bold text-secondary">Loading Direct Distribution Data...</h4>
        <p class="text-muted" id="loading-text">Connecting to Firebase...</p>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <span class="navbar-brand">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-map"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon><line x1="8" y1="2" x2="8" y2="18"></line><line x1="16" y1="6" x2="16" y2="22"></line></svg>
                Map By AI
            </span>
        </div>
    </nav>

    <!-- Filters Control Panel -->
    <div class="controls-bar">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label fw-bold small text-muted">Region</label>
                <select id="regionFilter" class="form-select">
                    <option value="All">All Regions</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold small text-muted">Route / Driver</label>
                <select id="routeFilter" class="form-select">
                    <option value="All">All Routes</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold small text-muted">Day</label>
                <select id="dayFilter" class="form-select">
                    <option value="All">All Days</option>
                </select>
            </div>
            <div class="col-md-3 text-end">
                <button onclick="resetFilters()" class="btn btn-outline-secondary btn-sm w-100">
                    Reset Filters
                </button>
            </div>
        </div>
    </div>

    <!-- Main Map Area -->
    <div id="map"></div>

    <!-- Floating Stats -->
    <div class="stats-card">
        <div class="stats-number" id="visibleCount">0</div>
        <div class="stats-label">Clients Visible</div>
    </div>

    <!-- Firebase SDKs (Compat version for simple HTML) -->
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // 1. Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBc4Aam5pdipIfc2B4Ymk4A3NRWxFHU8Dc",
            authDomain: "routegeniusai.firebaseapp.com",
            projectId: "routegeniusai",
            storageBucket: "routegeniusai.firebasestorage.app",
            messagingSenderId: "104065712296",
            appId: "1:104065712296:web:4929e6afc8fa96aac9429d",
            measurementId: "G-DSWXSXRG0C"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // 2. Global State
        let allClients = [];
        let map;
        let markersLayer;
        
        // Color Mapping
        const dayColors = {
            'Saturday': '#0d6efd',  // Blue
            'Sunday': '#dc3545',    // Red
            'Monday': '#198754',    // Green
            'Tuesday': '#fd7e14',   // Orange
            'Wednesday': '#6f42c1', // Purple
            'Thursday': '#795548',  // Brown
            'Friday': '#212529',    // Black
            'Unscheduled': '#adb5bd' // Grey
        };

        // 3. Initialize Map
        function initMap() {
            // Center on Saudi Arabia
            map = L.map('map').setView([24.7136, 46.6753], 6); 

            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            markersLayer = L.layerGroup().addTo(map);
        }

        // 4. Data Fetching
        async function fetchData() {
            const loadingText = document.getElementById('loading-text');
            try {
                loadingText.textContent = "Fetching route chunks...";
                
                // Get chunks from the active_routes subcollection
                const snapshot = await db.collection('users_data')
                                       .doc('active_routes')
                                       .collection('chunks')
                                       .get();

                if (snapshot.empty) {
                    loadingText.textContent = "No data found in database.";
                    return;
                }

                let rawData = [];
                snapshot.forEach(doc => {
                    const chunk = doc.data();
                    if (chunk.data && Array.isArray(chunk.data)) {
                        rawData = rawData.concat(chunk.data);
                    }
                });

                loadingText.textContent = `Processing ${rawData.length} records...`;

                // Normalize Data (Map CSV fields or App fields to a standard format)
                allClients = rawData.map(c => ({
                    nameEn: c.client_descreption || c.name || "Unknown",
                    nameAr: c.client_Arabic || c.nameAr || "",
                    code: c.r_Client_Code || c.clientCode || "N/A",
                    lat: Number(c.latitude || c.lat),
                    lng: Number(c.longitude || c.lng),
                    region: c.Region_Description || c.regionDescription || "Unknown Region",
                    route: c.Route_Description || c.routeName || "Unassigned",
                    day: normalizeDay(c.day)
                })).filter(c => !isNaN(c.lat) && !isNaN(c.lng) && c.lat !== 0 && c.lng !== 0);

                populateFilters();
                renderMap();
                
                // Hide Loading Overlay
                setTimeout(() => {
                    document.getElementById('loading-overlay').style.display = 'none';
                }, 500);

            } catch (error) {
                console.error("Error fetching data:", error);
                loadingText.textContent = "Error: " + error.message;
                loadingText.style.color = "red";
            }
        }

        function normalizeDay(dayRaw) {
            if (!dayRaw) return 'Unscheduled';
            const d = String(dayRaw).trim();
            // Basic normalization
            if (['Saturday', 'Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'].includes(d)) return d;
            return d || 'Unscheduled';
        }

        // 5. Filter Logic
        function populateFilters() {
            const regions = new Set();
            const routes = new Set();
            const days = new Set();

            allClients.forEach(c => {
                if (c.region) regions.add(c.region);
                if (c.route) routes.add(c.route);
                if (c.day) days.add(c.day);
            });

            populateSelect('regionFilter', Array.from(regions).sort());
            populateSelect('routeFilter', Array.from(routes).sort());
            populateSelect('dayFilter', Array.from(days).sort());
        }

        function populateSelect(id, items) {
            const select = document.getElementById(id);
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                select.appendChild(option);
            });
            // Add Event Listener
            select.addEventListener('change', renderMap);
        }

        function resetFilters() {
            document.getElementById('regionFilter').value = 'All';
            document.getElementById('routeFilter').value = 'All';
            document.getElementById('dayFilter').value = 'All';
            renderMap();
            // Reset View
            map.setView([24.7136, 46.6753], 6);
        }

        // 6. Rendering Logic
        function renderMap() {
            markersLayer.clearLayers();

            const selectedRegion = document.getElementById('regionFilter').value;
            const selectedRoute = document.getElementById('routeFilter').value;
            const selectedDay = document.getElementById('dayFilter').value;

            const filtered = allClients.filter(c => {
                return (selectedRegion === 'All' || c.region === selectedRegion) &&
                       (selectedRoute === 'All' || c.route === selectedRoute) &&
                       (selectedDay === 'All' || c.day === selectedDay);
            });

            // Update Stats
            document.getElementById('visibleCount').textContent = filtered.length.toLocaleString();

            const bounds = [];

            filtered.forEach(c => {
                const color = dayColors[c.day] || '#6c757d'; // Default grey
                
                // Create custom circle marker using CSS
                const customIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div class="custom-marker" style="background-color: ${color}; width: 14px; height: 14px;"></div>`,
                    iconSize: [14, 14],
                    iconAnchor: [7, 7]
                });

                const marker = L.marker([c.lat, c.lng], { icon: customIcon })
                    .bindPopup(`
                        <div style="font-family: 'Cairo', sans-serif; text-align: center;">
                            <strong style="font-size: 1.1em; color: #2a5298;">${c.nameAr}</strong><br/>
                            <span style="font-size: 0.9em; color: #555;">${c.nameEn}</span>
                            <hr style="margin: 5px 0;"/>
                            <div style="text-align: left; font-size: 0.85em;">
                                <strong>Code:</strong> ${c.code}<br/>
                                <strong>Day:</strong> <span style="color:${color}; font-weight:bold;">${c.day}</span><br/>
                                <strong>Route:</strong> ${c.route}
                            </div>
                        </div>
                    `);
                
                markersLayer.addLayer(marker);
                bounds.push([c.lat, c.lng]);
            });

            // Auto Zoom logic
            if (selectedRoute !== 'All' && bounds.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }

        // Start Application
        window.addEventListener('DOMContentLoaded', () => {
            initMap();
            fetchData();
        });

    </script>
</body>
</html>